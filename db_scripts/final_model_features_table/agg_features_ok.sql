DROP TABLE IF EXISTS prototype_features;

CREATE TABLE prototype_features AS(

WITH agg_features AS (
    select coloniaid, avg(personal_risk_index) as personal_risk_index, avg(personal_age) as personal_age, avg(personal_age_relative) as personal_age_relative, avg(personal_daily_wage) as personal_daily_wage, avg(personal_daily_wage_relative) as personal_daily_wage_relative, avg(personal_married) as personal_married, avg(personal_gender) as personal_gender, avg(acquisitive_vsm_4) as acquisitive_vsm_4, avg(loan_value) as loan_value, avg(loan_value_relative) as loan_value_relative, avg(loan_interest_rate) as loan_interest_rate, avg(loan_interest_rate_relative) as loan_interest_rate_relative, avg(loan_subaccount_value) as loan_subaccount_value, avg(loan_subaccount_value_relative) as loan_subaccount_value_relative, avg(loan_total_subsidy) as loan_total_subsidy, avg(loan_total_subsidy_relative) as loan_total_subsidy_relative, avg(loan_voluntary_contrib) as loan_voluntary_contrib, avg(loan_sales_price) as loan_sales_price, avg(loan_acquisitive) as loan_acquisitive, avg(loan_acquisitive_vsm) as loan_acquisitive_vsm, avg(loan_max_credit) as loan_max_credit, avg(loan_max_credit_vsm) as loan_max_credit_vsm, avg(loan_wage_vsm) as loan_wage_vsm, avg(loan_sales_price_relative) as loan_sales_price_relative, avg(loan_joint) as loan_joint, avg(loan_home_type) as loan_home_type, avg(loan_building_type) as loan_building_type, avg(loan_value_vsm) as loan_value_vsm from master_loan_features_version4 WHERE cur_year=2015 group by coloniaid
    --limit 100
), subwindow AS (
    select *,row_number() over w as rn from master_loan_features_version4
    where cur_year=2015 and past=1
    window w as (partition by coloniaid range between unbounded preceding and unbounded following)
), features AS(
    select coloniaid, hospital_escore, parks_escore, markets_escore, schools_escore, equip_escore, references_escore, transportation_escore, roads_transport_escore, living_area_escore, sustainability_escore, validitiy_index_escore, satisfaction_escore, digital_escore, housing_quality_escore, water_escore, power_escore, community_escore, total_escore, hospital_escore_relative, parks_escore_relative, markets_escore_relative, schools_escore_relative, equip_escore_relative, references_escore_relative, transportation_escore_relative, roads_transport_escore_relative, living_area_escore_relative, sustainability_escore_relative, validitiy_index_escore_relative, satisfaction_escore_relative, digital_escore_relative, housing_quality_escore_relative, water_escore_relative, power_escore_relative, community_escore_relative, total_escore_relative, colonia_num_loans, colonia_num_abd, colonia_num_abd_first_year, colonia_num_newgranted_cur_year, colonia_avg_loan_val, colonia_max_loan_val, colonia_min_loan_val, colonia_avg_age, colonia_avg_income, colonia_avg_subaccount, colonia_avg_subsidy, colonia_max_subsidy, colonia_avg_sales_price, colonia_max_sales_price, colonia_min_sales_price, colonia_avg_interest_rate, colonia_avg_hospital_escore, colonia_avg_parks_escore, colonia_avg_markets_escore, colonia_avg_schools_escore, colonia_avg_equip_escore, colonia_avg_references_escore, colonia_avg_transportation_escore, colonia_avg_roads_transport_escore, colonia_avg_living_area_escore, colonia_avg_sustainability_escore, colonia_avg_validitiy_index_escore, colonia_avg_satisfaction_escore, colonia_avg_digital_escore, colonia_avg_housing_quality_escore, colonia_avg_water_escore, colonia_avg_power_escore, colonia_avg_community_escore, colonia_avg_total_escore, colonia_abd_percent, colonia_num_abd_first_year_percent, mun_average_degree_of_schooling_of_the_population_15_years_and_, mun_households_estimation, mun_percentage_of_population_15_to_29_years_estimation, mun_percentage_of_population_60_or_more_years_estimation, mun_total_population_estimation, mun_total_population_men_estimation, mun_total_population_women_estimation, mun_homicide_rate, mun_male_homicide_rate, mun_female_homicide_rate, mun_effectpeopledead, mun_effectpeoplemissing, mun_effectpeopleinjured, mun_effectpeopleharmed, mun_effectpeopleaffected, mun_effectpeopleevacuated, mun_effectpeoplerelocated, mun_effecthousesdestroyed, mun_effecthousesaffected, mun_effectlossesvalueusd, mun_motor_vehicles_rate, mun_motorcycles_rate, mun_passenger_buses_rate, mun_trucks_and_vans_rate, mun_vehicles_rate, mun_births_rate, mun_births_men_rate, mun_births_sex_unspecified_rate, mun_births_women_rate, mun_deaths_of_infants_under_one_year_rate, mun_deaths_of_infants_under_one_year_men_rate, mun_deaths_of_infants_under_one_year_old_sex_not_specified_rate, mun_deaths_of_infants_under_one_year_women_rate, mun_divorces_rate, mun_general_deaths_rate, mun_general_deaths_men_rate, mun_general_deaths_unspecified_sex_rate, mun_general_deaths_women_rate, mun_marriages_rate, mun_gross_expenditure_per_capita, no_employee_0_2_5k, no_employee_0_5k, no_employee_0_10k, no_employee_0_15k, no_employee_0_20k, no_employee_0_25k, no_employee_0_30k, no_employee_0_35k, no_employee_0_40k, no_employee_0_45k, no_employee_0_50k, no_businesses_0_2_5k, no_businesses_0_5k, no_businesses_0_10k, no_businesses_0_15k, no_businesses_0_20k, no_businesses_0_25k, no_businesses_0_30k, no_businesses_0_35k, no_businesses_0_40k, no_businesses_0_45k, no_businesses_0_50k, no_employee_2_5_5k, no_employee_5_10k, no_employee_10_15k, no_employee_15_20k, no_employee_20_25k, no_employee_25_30k, no_employee_30_35k, no_employee_35_40k, no_employee_40_45k, no_employee_45_50k, no_businesses_2_5_5k, no_businesses_5_10k, no_businesses_10_15k, no_businesses_15_20k, no_businesses_20_25k, no_businesses_25_30k, no_businesses_30_35k, no_businesses_35_40k, no_businesses_40_45k, no_businesses_45_50k, no_busemp_0_2_5k, no_busemp__0_5k, no_busemp__0_10k, no_busemp__0_15k, no_busemp__0_20k, no_busemp__0_25k, no_busemp__0_30k, no_busemp__0_35k, no_busemp__0_40k, no_busemp__0_45k, no_busemp__0_50k, no_busemp_2_5_5k, no_busemp_5_10k, no_busemp_10_15k, no_busemp_15_20k, no_busemp_20_25k, no_busemp_25_30k, no_busemp_30_35k, no_busemp_35_40k, no_busemp_40_45k, no_busemp_45_50k, no_employee_6111_0_2_5k, no_employee_6111_0_5k, no_employee_6111_0_10k, no_employee_6111_0_15k, no_employee_6111_0_20k, no_employee_6111_0_25k, no_employee_6111_0_30k, no_employee_6111_0_35k, no_employee_6111_0_40k, no_employee_6111_0_45k, no_employee_6111_0_50k, no_businesses_6111_0_2_5k, no_businesses_6111_0_5k, no_businesses_6111_0_10k, no_businesses_6111_0_15k, no_businesses_6111_0_20k, no_businesses_6111_0_25k, no_businesses_6111_0_30k, no_businesses_6111_0_35k, no_businesses_6111_0_40k, no_businesses_6111_0_45k, no_businesses_6111_0_50k, no_employee_6111_2_5_5k, no_employee_6111_5_10k, no_employee_6111_10_15k, no_employee_6111_15_20k, no_employee_6111_20_25k, no_employee_6111_25_30k, no_employee_6111_30_35k, no_employee_6111_35_40k, no_employee_6111_40_45k, no_employee_6111_45_50k, no_businesses_6111_2_5_5k, no_businesses_6111_5_10k, no_businesses_6111_10_15k, no_businesses_6111_15_20k, no_businesses_6111_20_25k, no_businesses_6111_25_30k, no_businesses_6111_30_35k, no_businesses_6111_35_40k, no_businesses_6111_40_45k, no_businesses_6111_45_50k, no_employee_622_0_2_5k, no_employee_622_0_5k, no_employee_622_0_10k, no_employee_622_0_15k, no_employee_622_0_20k, no_employee_622_0_25k, no_employee_622_0_30k, no_employee_622_0_35k, no_employee_622_0_40k, no_employee_622_0_45k, no_employee_622_0_50k, no_businesses_622_0_2_5k, no_businesses_622_0_5k, no_businesses_622_0_10k, no_businesses_622_0_15k, no_businesses_622_0_20k, no_businesses_622_0_25k, no_businesses_622_0_30k, no_businesses_622_0_35k, no_businesses_622_0_40k, no_businesses_622_0_45k, no_businesses_622_0_50k, no_employee_622_2_5_5k, no_employee_622_5_10k, no_employee_622_10_15k, no_employee_622_15_20k, no_employee_622_20_25k, no_employee_622_25_30k, no_employee_622_30_35k, no_employee_622_35_40k, no_employee_622_40_45k, no_employee_622_45_50k, no_businesses_622_2_5_5k, no_businesses_622_5_10k, no_businesses_622_10_15k, no_businesses_622_15_20k, no_businesses_622_20_25k, no_businesses_622_25_30k, no_businesses_622_30_35k, no_businesses_622_35_40k, no_businesses_622_40_45k, no_businesses_622_45_50k, no_employee_461_0_2_5k, no_employee_461_0_5k, no_employee_461_0_10k, no_employee_461_0_15k, no_employee_461_0_20k, no_employee_461_0_25k, no_employee_461_0_30k, no_employee_461_0_35k, no_employee_461_0_40k, no_employee_461_0_45k, no_employee_461_0_50k, no_businesses_461_0_2_5k, no_businesses_461_0_5k, no_businesses_461_0_10k, no_businesses_461_0_15k, no_businesses_461_0_20k, no_businesses_461_0_25k, no_businesses_461_0_30k, no_businesses_461_0_35k, no_businesses_461_0_40k, no_businesses_461_0_45k, no_businesses_461_0_50k, no_employee_461_2_5_5k, no_employee_461_5_10k, no_employee_461_10_15k, no_employee_461_15_20k, no_employee_461_20_25k, no_employee_461_25_30k, no_employee_461_30_35k, no_employee_461_35_40k, no_employee_461_40_45k, no_employee_461_45_50k, no_businesses_461_2_5_5k, no_businesses_461_5_10k, no_businesses_461_10_15k, no_businesses_461_15_20k, no_businesses_461_20_25k, no_businesses_461_25_30k, no_businesses_461_30_35k, no_businesses_461_35_40k, no_businesses_461_40_45k, no_businesses_461_45_50k, no_employee_46211_0_2_5k, no_employee_46211_0_5k, no_employee_46211_0_10k, no_employee_46211_0_15k, no_employee_46211_0_20k, no_employee_46211_0_25k, no_employee_46211_0_30k, no_employee_46211_0_35k, no_employee_46211_0_40k, no_employee_46211_0_45k, no_employee_46211_0_50k, no_businesses_46211_0_2_5k, no_businesses_46211_0_5k, no_businesses_46211_0_10k, no_businesses_46211_0_15k, no_businesses_46211_0_20k, no_businesses_46211_0_25k, no_businesses_46211_0_30k, no_businesses_46211_0_35k, no_businesses_46211_0_40k, no_businesses_46211_0_45k, no_businesses_46211_0_50k, no_employee_46211_2_5_5k, no_employee_46211_5_10k, no_employee_46211_10_15k, no_employee_46211_15_20k, no_employee_46211_20_25k, no_employee_46211_25_30k, no_employee_46211_30_35k, no_employee_46211_35_40k, no_employee_46211_40_45k, no_employee_46211_45_50k, no_businesses_46211_2_5_5k, no_businesses_46211_5_10k, no_businesses_46211_10_15k, no_businesses_46211_15_20k, no_businesses_46211_20_25k, no_businesses_46211_25_30k, no_businesses_46211_30_35k, no_businesses_46211_35_40k, no_businesses_46211_40_45k, no_businesses_46211_45_50k, no_employee_722_0_2_5k, no_employee_722_0_5k, no_employee_722_0_10k, no_employee_722_0_15k, no_employee_722_0_20k, no_employee_722_0_25k, no_employee_722_0_30k, no_employee_722_0_35k, no_employee_722_0_40k, no_employee_722_0_45k, no_employee_722_0_50k, no_businesses_722_0_2_5k, no_businesses_722_0_5k, no_businesses_722_0_10k, no_businesses_722_0_15k, no_businesses_722_0_20k, no_businesses_722_0_25k, no_businesses_722_0_30k, no_businesses_722_0_35k, no_businesses_722_0_40k, no_businesses_722_0_45k, no_businesses_722_0_50k, no_employee_722_2_5_5k, no_employee_722_5_10k, no_employee_722_10_15k, no_employee_722_15_20k, no_employee_722_20_25k, no_employee_722_25_30k, no_employee_722_30_35k, no_employee_722_35_40k, no_employee_722_40_45k, no_employee_722_45_50k, no_businesses_722_2_5_5k, no_businesses_722_5_10k, no_businesses_722_10_15k, no_businesses_722_15_20k, no_businesses_722_20_25k, no_businesses_722_25_30k, no_businesses_722_30_35k, no_businesses_722_35_40k, no_businesses_722_40_45k, no_businesses_722_45_50k, no_employee_81321_0_2_5k, no_employee_81321_0_5k, no_employee_81321_0_10k, no_employee_81321_0_15k, no_employee_81321_0_20k, no_employee_81321_0_25k, no_employee_81321_0_30k, no_employee_81321_0_35k, no_employee_81321_0_40k, no_employee_81321_0_45k, no_employee_81321_0_50k, no_businesses_81321_0_2_5k, no_businesses_81321_0_5k, no_businesses_81321_0_10k, no_businesses_81321_0_15k, no_businesses_81321_0_20k, no_businesses_81321_0_25k, no_businesses_81321_0_30k, no_businesses_81321_0_35k, no_businesses_81321_0_40k, no_businesses_81321_0_45k, no_businesses_81321_0_50k, no_employee_81321_2_5_5k, no_employee_81321_5_10k, no_employee_81321_10_15k, no_employee_81321_15_20k, no_employee_81321_20_25k, no_employee_81321_25_30k, no_employee_81321_30_35k, no_employee_81321_35_40k, no_employee_81321_40_45k, no_employee_81321_45_50k, no_businesses_81321_2_5_5k, no_businesses_81321_5_10k, no_businesses_81321_10_15k, no_businesses_81321_15_20k, no_businesses_81321_20_25k, no_businesses_81321_25_30k, no_businesses_81321_30_35k, no_businesses_81321_35_40k, no_businesses_81321_40_45k, no_businesses_81321_45_50k, no_busemp_6111_0_2_5k, no_busemp_6111_0_5k, no_busemp_6111_0_10k, no_busemp_6111_0_15k, no_busemp_6111_0_20k, no_busemp_6111_0_25k, no_busemp_6111_0_30k, no_busemp_6111_0_35k, no_busemp_6111_0_40k, no_busemp_6111_0_45k, no_busemp_6111_0_50k, no_busemp_6111_2_5_5k, no_busemp_6111_5_10k, no_busemp_6111_10_15k, no_busemp_6111_15_20k, no_busemp_6111_20_25k, no_busemp_6111_25_30k, no_busemp_6111_30_35k, no_busemp_6111_35_40k, no_busemp_6111_40_45k, no_busemp_6111_45_50k, no_busemp_622_0_2_5k, no_busemp_622_0_5k, no_busemp_622_0_10k, no_busemp_622_0_15k, no_busemp_622_0_20k, no_busemp_622_0_25k, no_busemp_622_0_30k, no_busemp_622_0_35k, no_busemp_622_0_40k, no_busemp_622_0_45k, no_busemp_622_0_50k, no_busemp_622_2_5_5k, no_busemp_622_5_10k, no_busemp_622_10_15k, no_busemp_622_15_20k, no_busemp_622_20_25k, no_busemp_622_25_30k, no_busemp_622_30_35k, no_busemp_622_35_40k, no_busemp_622_40_45k, no_busemp_622_45_50k, no_busemp_461_0_2_5k, no_busemp_461_0_5k, no_busemp_461_0_10k, no_busemp_461_0_15k, no_busemp_461_0_20k, no_busemp_461_0_25k, no_busemp_461_0_30k, no_busemp_461_0_35k, no_busemp_461_0_40k, no_busemp_461_0_45k, no_busemp_461_0_50k, no_busemp_461_2_5_5k, no_busemp_461_5_10k, no_busemp_461_10_15k, no_busemp_461_15_20k, no_busemp_461_20_25k, no_busemp_461_25_30k, no_busemp_461_30_35k, no_busemp_461_35_40k, no_busemp_461_40_45k, no_busemp_461_45_50k, no_busemp_46211_0_2_5k, no_busemp_46211_0_5k, no_busemp_46211_0_10k, no_busemp_46211_0_15k, no_busemp_46211_0_20k, no_busemp_46211_0_25k, no_busemp_46211_0_30k, no_busemp_46211_0_35k, no_busemp_46211_0_40k, no_busemp_46211_0_45k, no_busemp_46211_0_50k, no_busemp_46211_2_5_5k, no_busemp_46211_5_10k, no_busemp_46211_10_15k, no_busemp_46211_15_20k, no_busemp_46211_20_25k, no_busemp_46211_25_30k, no_busemp_46211_30_35k, no_busemp_46211_35_40k, no_busemp_46211_40_45k, no_busemp_46211_45_50k, no_busemp_722_0_2_5k, no_busemp_722_0_5k, no_busemp_722_0_10k, no_busemp_722_0_15k, no_busemp_722_0_20k, no_busemp_722_0_25k, no_busemp_722_0_30k, no_busemp_722_0_35k, no_busemp_722_0_40k, no_busemp_722_0_45k, no_busemp_722_0_50k, no_busemp_722_2_5_5k, no_busemp_722_5_10k, no_busemp_722_10_15k, no_busemp_722_15_20k, no_busemp_722_20_25k, no_busemp_722_25_30k, no_busemp_722_30_35k, no_busemp_722_35_40k, no_busemp_722_40_45k, no_busemp_722_45_50k, no_busemp_81321_0_2_5k, no_busemp_81321_0_5k, no_busemp_81321_0_10k, no_busemp_81321_0_15k, no_busemp_81321_0_20k, no_busemp_81321_0_25k, no_busemp_81321_0_30k, no_busemp_81321_0_35k, no_busemp_81321_0_40k, no_busemp_81321_0_45k, no_busemp_81321_0_50k, no_busemp_81321_2_5_5k, no_busemp_81321_5_10k, no_busemp_81321_10_15k, no_busemp_81321_15_20k, no_busemp_81321_20_25k, no_busemp_81321_25_30k, no_busemp_81321_30_35k, no_busemp_81321_35_40k, no_busemp_81321_40_45k, no_busemp_81321_45_50k  from subwindow  where rn=1
    --limit 100
)

SELECT * FROM agg_features JOIN features USING (coloniaid)

);

ALTER TABLE prototype_features
ADD years_since_granted int4;

UPDATE prototype_features
SET years_since_granted=1;

CREATE INDEX idx_coloniaid ON prototype_features(coloniaid);


-- SELECT cv_credito, coloniaid, personal_daily_wage, personal_age, no_busemp__0_40k
-- FROM master_loan_features_version4 WHERE coloniaid=100 AND cur_year=2015

-- SELECT coloniaid, personal_daily_wage, personal_age, no_busemp__0_40k
-- FROM prototype_features WHERE coloniaid=100